<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Joystick Bluetooth Car</title>
<style>
  body { background:#f0f0f0; text-align:center; font-family:Arial; }
  #status { margin:20px; font-size:22px; font-weight:bold; }
  #connect { padding:15px 25px; font-size:20px; border-radius:10px; }
  canvas { background:#fff; border:2px solid #000; border-radius:50%; margin-top:20px; }
</style>
</head>
<body>

<h2>ðŸš— Joystick Controller</h2>

<div id="status">Disconnected</div>
<button id="connect">ðŸ”µ Connect</button>

<br>
<canvas id="joy" width="250" height="250"></canvas>

<script>
let port, writer;
let joy = document.getElementById("joy");
let ctx = joy.getContext("2d");

let joyX = 125, joyY = 125;
let dragging = false;

async function connect() {
    try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });

        writer = port.writable.getWriter();
        document.getElementById("status").innerText = "Connected âœ”";
        document.getElementById("status").style.color = "green";
    } catch (e) {
        document.getElementById("status").innerText = "Connection failed";
        document.getElementById("status").style.color = "red";
    }
}

document.getElementById("connect").onclick = connect;

function sendJoystick(x, y) {
    if (!writer) return;

    let msg = `JS${x},${y}\n`;
    writer.write(new TextEncoder().encode(msg));
}

function drawJoystick() {
    ctx.clearRect(0,0,250,250);

    ctx.beginPath();
    ctx.arc(125,125,110,0,Math.PI*2);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(joyX, joyY, 30, 0, Math.PI*2);
    ctx.fillStyle = "#00aaff";
    ctx.fill();
}

joy.addEventListener("mousedown", e => { dragging = true; });
joy.addEventListener("mouseup", e => {
    dragging = false;
    joyX = 125; joyY = 125;
    sendJoystick(0,0);
    drawJoystick();
});
joy.addEventListener("mousemove", e => {
    if (!dragging) return;
    let rect = joy.getBoundingClientRect();
    joyX = e.clientX - rect.left;
    joyY = e.clientY - rect.top;

    joyX = Math.max(20, Math.min(230, joyX));
    joyY = Math.max(20, Math.min(230, joyY));

    let X = Math.round(((joyX - 125) / 110) * 100);
    let Y = Math.round(((125 - joyY) / 110) * 100);

    sendJoystick(X, Y);
    drawJoystick();
});

drawJoystick();
</script>
</body>
</html>
