<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Robot Controller</title>
<style>
  body { font-family: Arial; background:#f0f0f0; text-align:center; }
  #status { padding:10px; margin:10px; font-size:20px; }
  .ok { color:green; }
  .bad { color:red; }
  .panel { background:white; padding:15px; width:300px; margin:auto; border-radius:12px; }
  button { margin:8px; padding:15px 20px; font-size:20px; border-radius:10px; }
  .telemetry { font-size:18px; margin-top:15px; text-align:left; }
</style>
</head>
<body>

<h2>üöó Robot Controller + Telemetry</h2>

<div id="status" class="bad">Disconnected</div>
<button id="connectBtn">üîµ Connect</button>

<div class="panel">
  <h3>Controls</h3>
  <button onclick="send('U')">‚¨Ü</button><br>
  <button onclick="send('L')">‚¨Ö</button>
  <button onclick="send('S')">‚èπ</button>
  <button onclick="send('R')">‚û°</button><br>
  <button onclick="send('D')">‚¨á</button>

  <div class="telemetry">
    <p>üìè Distance: <span id="dist">--</span> cm</p>
    <p>üö´ IR Obstacle: <span id="ir">--</span></p>
    <p>üß≠ Command: <span id="cmd">--</span></p>
  </div>
</div>

<script>
let port, reader, writer;

async function connect() {
  port = await navigator.serial.requestPort();
  await port.open({ baudRate: 9600 });
  writer = port.writable.getWriter();
  document.getElementById("status").textContent = "Connected ‚úî";
  document.getElementById("status").className = "ok";
  listen();
}

async function listen() {
  reader = port.readable.getReader();
  let buffer = "";

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    buffer += new TextDecoder().decode(value);
    let lines = buffer.split("\n");
    buffer = lines.pop();

    for (let line of lines) {
      try {
        let data = JSON.parse(line);
        document.getElementById("dist").textContent = data.dist.toFixed(1);
        document.getElementById("ir").textContent = data.ir;
        document.getElementById("cmd").textContent = data.cmd;
      } catch {}
    }
  }
}

async function send(cmd) {
  if (!writer) return alert("Connect first!");
  await writer.write(new TextEncoder().encode(cmd));
}

document.getElementById("connectBtn").onclick = connect;
</script>

</body>
</html>
