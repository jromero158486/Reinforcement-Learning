<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Robot RL Research Panel</title>

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:#f5f7fa;
  color:#222;
}

header {
  background:#1e2a38;
  color:white;
  padding:14px 20px;
  font-size:22px;
  font-weight:bold;
}

#container {
  display:flex;
  height: calc(100vh - 60px);
}

/* Left column ‚Äì controls */
#left {
  width:40%;
  border-right:1px solid #ccc;
  padding:20px;
}

.sectionTitle {
  font-size:20px;
  margin-top:10px;
  border-bottom:2px solid #ddd;
  margin-bottom:10px;
}

button {
  padding:12px 18px;
  font-size:18px;
  margin:6px;
  border-radius:8px;
  cursor:pointer;
  border:1px solid #bbb;
  background:white;
}
button:active { background:#ddd; }

.arrowBtn {
  width:80px;
  height:80px;
  font-size:30px;
}

.statusBox {
  padding:10px;
  background:white;
  border-radius:8px;
  margin-top:10px;
  border:1px solid #ccc;
}

/* Right column ‚Äì Q table + console */
#right {
  width:60%;
  padding:20px;
  overflow:auto;
}

.qcell {
  width:80px;
  height:30px;
  display:inline-block;
  margin:4px;
  border-radius:6px;
  text-align:center;
  line-height:30px;
  font-size:14px;
  transition:0.2s;
}

#qtable { margin-top:10px; }

/* Radar canvas */
#radarCanvas {
  background:#111;
  border-radius:12px;
  border: 1px solid #333;
  margin-bottom:20px;
}
#log {
  background:#0e0e0e;
  color:#00ff00;
  padding:10px;
  border-radius:8px;
  height:200px;
  overflow-y:auto;
  font-family: monospace;
  font-size:13px;
}
</style>
</head>

<body>

<header>üì° Robot RL ‚Äì Research Control Panel</header>

<div id="container">

  <!-- LEFT PANEL -->
  <div id="left">

    <div class="sectionTitle">Connection</div>
    <button id="connectBtn">üîå Connect</button>
    <div id="status" class="statusBox">Disconnected</div>

    <div class="sectionTitle">Manual Control</div>

    <div>
      <button class="arrowBtn" id="upBtn">‚¨Ü</button><br>
      <button class="arrowBtn" id="leftBtn">‚¨Ö</button>
      <button class="arrowBtn" id="stopBtn">‚èπ</button>
      <button class="arrowBtn" id="rightBtn">‚û°</button><br>
      <button class="arrowBtn" id="downBtn">‚¨á</button>
    </div>

    <div class="sectionTitle">Mode</div>
    <button id="manualMode">Manual</button>
    <button id="autoMode">Autonomous RL</button>

    <div class="sectionTitle">Telemetry</div>
    <div id="telemetry" class="statusBox">
      dist: -- cm<br>
      ir: --<br>
      cmd: --<br>
      reward: --<br>
      state: --<br>
    </div>

  </div>

  <!-- RIGHT PANEL -->
  <div id="right">

    <div class="sectionTitle">Live Radar (Ultrasound)</div>
    <canvas id="radarCanvas" width="350" height="200"></canvas>

    <div class="sectionTitle">Q-Table (Heatmap)</div>
    <div id="qtable"></div>

    <div class="sectionTitle">RL Console</div>
    <pre id="log"></pre>

  </div>
</div>


<script>
let port, reader, writer;
let buffer = "";
let radarDist = 0;

/* =======================================================
   LOG FUNCTION
======================================================= */
function log(t){
  const el = document.getElementById("log");
  el.textContent += t + "\n";
  el.scrollTop = el.scrollHeight;
}

/* =======================================================
   COLOR FOR Q-TABLE
======================================================= */
function valueToColor(v) {
  let r = v < 0 ? 255 : 120 - v*120;
  let g = v > 0 ? 255 : 120 + v*120;
  return `rgb(${r},${g},120)`;
}

function renderQTable(q) {
  let html = "";
  for (let s = 0; s < q.length; s++) {
    html += `<div><b>State ${s}</b>: `;
    for (let a = 0; a < q[s].length; a++) {
      let val = q[s][a];
      let color = valueToColor(val);
      html += `<div class='qcell' style='background:${color}'>${val.toFixed(2)}</div>`;
    }
    html += "</div>";
  }
  document.getElementById("qtable").innerHTML = html;
}

/* =======================================================
   RADAR DRAWING
======================================================= */
const radar = document.getElementById("radarCanvas");
const ctx = radar.getContext("2d");

function drawRadar() {
  ctx.clearRect(0, 0, radar.width, radar.height);

  const cx = radar.width / 2;
  const cy = radar.height;
  const maxRange = 100;

  ctx.strokeStyle = "#444";
  ctx.lineWidth = 1;
  for (let r = 40; r <= maxRange; r += 20) {
    ctx.beginPath();
    ctx.arc(cx, cy, r * 2, Math.PI, Math.PI * 2);
    ctx.stroke();
  }

  // Lines left-right
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx - 200, cy);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx + 200, cy);
  ctx.stroke();

  // Radar point
  let d = Math.min(radarDist, maxRange);
  let px = cx;
  let py = cy - d * 2;

  let color = "#00ff00";
  if (d < 15) color = "#ff0000";
  else if (d < 30) color = "#ffaa00";

  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(px, py, 8, 0, Math.PI * 2);
  ctx.fill();

  requestAnimationFrame(drawRadar);
}
requestAnimationFrame(drawRadar);

/* =======================================================
   CONNECT TO SERIAL
======================================================= */
document.getElementById("connectBtn").onclick = async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });

    reader = port.readable.getReader();
    writer = port.writable.getWriter();

    document.getElementById("status").innerHTML = "Connected ‚úî";

    readLoop();
  } catch (e) {
    document.getElementById("status").innerHTML = "Connection Failed";
  }
};

/* =======================================================
   READING FROM ARDUINO
======================================================= */
async function readLoop() {
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    buffer += new TextDecoder().decode(value);

    let lines = buffer.split("\n");
    buffer = lines.pop();

    for (let line of lines) {
      try {
        let data = JSON.parse(line);

        // Telemetry update
        if (data.dist !== undefined) {
          radarDist = data.dist;

          document.getElementById("telemetry").innerHTML =
            `dist: ${data.dist}<br>ir: ${data.ir}<br>cmd: ${data.cmd}<br>reward: ${data.reward}<br>state: ${data.state}`;
        }

        // Q-table update
        if (data.qtable) renderQTable(data.qtable);

        // RL Log
        if (data.log) log(data.log);

      } catch(e) {}
    }
  }
}

/* =======================================================
   SEND COMMANDS
======================================================= */
async function send(cmd) {
  if (!writer) return alert("Not connected");
  await writer.write(new TextEncoder().encode(cmd));
}

/* HOLD-TO-MOVE BUTTONS */
const holdBtn = (id, cmd) => {
  let b = document.getElementById(id);

  b.onmousedown = () => send(cmd);
  b.onmouseup   = () => send("S");
  b.ontouchstart = () => send(cmd);
  b.ontouchend   = () => send("S");
};

holdBtn("upBtn", "U");
holdBtn("downBtn", "D");
holdBtn("leftBtn", "L");
holdBtn("rightBtn", "R");
holdBtn("stopBtn", "S");

document.getElementById("manualMode").onclick = () => send("M");
document.getElementById("autoMode").onclick  = () => send("A");
</script>

</body>
</html>
